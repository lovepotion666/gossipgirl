<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Tip Thread | V1.0 OFFICIAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400..900;1,6..96,400..900&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold-primary: #D4AF37;
            --gold-light: #F2D06B;
            --pink-neon: #FF007F;
            --blue-electric: #007AFF;

            --glass-surface: rgba(20, 20, 20, 0.75);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-highlight: rgba(255, 255, 255, 0.18);
            --glass-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9);

            --liquid-gold: linear-gradient(135deg, #BF953F 0%, #FCF6BA 40%, #AA771C 100%);
            --liquid-dark: linear-gradient(180deg, #1a1a1a 0%, #000000 100%);

            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.15);
            --ease-silk: cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro", "SF Arabic", "Segoe UI", Roboto, sans-serif; letter-spacing: -0.015em; }

        @media (prefers-reduced-motion: reduce) {
            * { transition: none !important; animation: none !important; scroll-behavior: auto !important; }
        }

        @keyframes liquidReveal { 0% { opacity: 0; transform: translateY(30px) scale(0.96); filter: blur(10px); } 100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); } }

        body {
            background: #000; color: #fff; margin: 0;
            background-image:
                radial-gradient(circle at 50% 0%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 10% 90%, rgba(255, 0, 127, 0.08) 0%, transparent 40%),
                linear-gradient(to bottom, #050505, #000000);
            background-attachment: fixed;
            overflow-x: hidden; -webkit-font-smoothing: antialiased;
            padding-bottom: calc(140px + env(safe-area-inset-bottom));
        }

        .content-wrapper { animation: liquidReveal 0.8s var(--ease-silk) forwards; }

        .liquid-card {
            background: var(--glass-surface); backdrop-filter: blur(45px) saturate(180%);
            -webkit-backdrop-filter: blur(45px) saturate(180%); border: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-highlight); border-radius: 28px; box-shadow: var(--glass-shadow);
            transition: transform 0.4s var(--ease-spring); transform: translateZ(0); position: relative;
        }

        header {
            position: fixed; top: 0; width: 100%; z-index: 1000; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(255,255,255,0.05); transform: translateZ(0);
        }

        .container { max-width: 480px; margin: 0 auto; padding: 80px 20px 20px; width: 100%; }

        .badge { display:inline-flex; align-items:center; padding:4px 10px; border-radius:10px; font-size:9px; font-weight:700; text-transform:uppercase; margin-right:6px; margin-bottom:8px; border:1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); white-space:nowrap; letter-spacing:0.5px; }
        .b-gg { background:var(--liquid-gold); color:#000; box-shadow: 0 0 20px rgba(212,175,55,0.3); border:none; font-weight:800; }
        .b-new { background:#fff; color:#000; border:none; font-weight:800; }
        .b-verify { background:rgba(255,255,255,0.08); color:#fff; }
        .b-hot { background: rgba(255, 0, 127, 0.15); color:var(--pink-neon); border-color:var(--pink-neon); box-shadow:0 0 15px rgba(255,0,127,0.25); }

        .v-indicator { background:var(--blue-electric); color:white; min-width:16px; height:16px; border-radius:50%; font-size:9px; display:inline-flex; align-items:center; justify-content:center; margin-left:6px; box-shadow:0 0 10px rgba(0,122,255,0.6); font-weight:800; padding:0 4px; }

        .input-wrapper { position: fixed; bottom: calc(20px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%) translateZ(0); width: 92%; max-width: 450px; z-index: 9999; }

        .input-bar { display:flex; align-items:center; gap:12px; padding:8px 10px 8px 20px; border-radius:40px; background: rgba(20,20,20,0.9) !important; backdrop-filter: blur(40px) saturate(200%); box-shadow: 0 10px 40px rgba(0,0,0,0.8), inset 0 1px 1px rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); }

        #ci { flex:1; background:transparent; border:none; color:#fff; font-size:16px; padding:12px 0; outline:none; font-weight:400; }
        #ci::placeholder { color: rgba(255,255,255,0.3); }

        .action-btn { width:44px; height:44px; border-radius:50%; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
        .action-btn:active { transform: scale(0.8); }
        .btn-send { background:var(--liquid-gold); color:#000; font-weight:700; font-size:18px; box-shadow: 0 5px 15px rgba(212,175,55,0.3); }

        .verify-btn, .share-btn { flex:1; height:48px; border-radius:16px; font-size:11px; font-weight:800; text-transform:uppercase; letter-spacing:0.8px; cursor:pointer; transition:0.3s; display:flex; align-items:center; justify-content:center; }
        .verify-btn { background: rgba(0,122,255,0.15); color:#4DAFFF; border:1px solid rgba(0,122,255,0.3); }
        .verify-btn.active { background: var(--blue-electric); color: white; border-color: transparent; box-shadow: 0 0 20px rgba(0,122,255,0.5); }
        .share-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color:#fff; }

        .post-img-preview { width:100%; aspect-ratio:4/3; object-fit:cover; border-radius:20px; margin-bottom:25px; border:1px solid rgba(255,255,255,0.1); display:block; box-shadow:0 10px 30px rgba(0,0,0,0.5); cursor: zoom-in; }

        #lightbox { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10001; display:none; align-items:center; justify-content:center; backdrop-filter: blur(10px); }
        #lightbox img { max-width:95%; max-height:90%; border-radius:12px; }

        .comment-swipe-zone { position:relative; touch-action: pan-y; margin-bottom:10px; transform: translateZ(0); }

        #captureArea { background:#000; border-radius:28px; overflow:hidden; position:relative; background-image: linear-gradient(135deg, #111 0%, #000 100%); }

        #ggToast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--liquid-gold); color: #000; padding: 12px 24px; border-radius: 20px; font-weight: 800; font-size: 11px; z-index: 10000; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); letter-spacing: 1px; text-align: center; white-space: nowrap; }
        .empty-state { text-align:center; padding:40px 20px; color: rgba(255,255,255,0.3); font-weight:600; font-size:14px; letter-spacing:0.5px; }

        .main-card { will-change: transform; }
    </style>
</head>
<body>

<div id="ggToast" role="status" aria-live="polite">VERIFIED BY GOSSIP GIRL</div>

<!-- Lightbox -->
<div id="lightbox" role="dialog" aria-modal="true" aria-hidden="true">
    <img src="" id="lightboxImg" alt="Full image">
</div>

<div class="content-wrapper">
    <header>
        <a href="index.html" style="color:var(--gold-primary); text-decoration:none; font-weight:700; font-size:11px; letter-spacing:1px; display:flex; align-items:center; gap:4px;" aria-label="Back to home">
            <span style="font-size:14px;">â€¹</span> BACK
        </a>
        <div style="font-family:'Bodoni Moda', serif; font-style:italic; font-weight:800; letter-spacing:0.5px; font-size:18px; background:var(--liquid-gold); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">Tip Thread</div>
        <div style="width:40px;"></div>
    </header>

    <main class="container" id="mainContainer">
        <div id="postArea" aria-live="polite"></div>

        <div style="margin:35px 0 15px 8px; display:flex; align-items:baseline; gap:10px;">
            <span style="font-weight:800; font-size:24px; letter-spacing:-0.5px; color:#fff;">Comments</span>
            <span id="commentCount" style="font-weight:700; font-size:16px; color:var(--gold-primary); opacity:0.8;">0</span>
        </div>

        <div id="cFeed" aria-live="polite"></div>
    </main>
</div>

<div class="input-wrapper" aria-label="Add a comment">
    <div id="replyBanner" style="display:none; pointer-events:auto; background: rgba(212,175,55,0.15); backdrop-filter: blur(20px); border-radius: 25px 25px 0 0; padding:10px 24px; font-size:10px; font-weight:800; justify-content:space-between; align-items:center; color:var(--gold-primary); border:1px solid rgba(212,175,55,0.3); border-bottom:none; margin:0 20px;">
        <span>REPLYING...</span>
        <span id="replyCancel" role="button" tabindex="0" style="cursor:pointer; background:rgba(0,0,0,0.4); color:#fff; padding:4px 10px; border-radius:12px; font-size:9px;">CANCEL</span>
    </div>

    <div class="liquid-card input-bar" role="form" aria-label="Comment form">
        <input type="text" id="ci" placeholder="Start controversy..." autocomplete="off" aria-label="Comment input">
        <button class="action-btn btn-send" id="cb" aria-label="Send comment">â†‘</button>
    </div>
</div>

<script>
/* Thread page - audited & hardened
   - Escaping user content
   - Defensive checks for firebase & html2canvas
   - Keyboard & accessibility improvements
   - Safer sharing fallback
   - Sanitized IDs and touch handling
*/

(function(){
    'use strict';

    // Utility: escape HTML to prevent XSS
    function escapeHTML(s) {
        if (s === null || s === undefined) return '';
        return String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;')
            .replace(/\//g, '&#x2F;');
    }
    function sanitizeForId(str) {
        if (!str) return 'id_unknown';
        return String(str).replace(/[^a-zA-Z0-9-_:.]/g, '_');
    }
    function safeNumber(n){ const v = Number(n); return isNaN(v)?0:v; }
    function timeAgo(t) {
        if(!t) return 'now';
        const s = Math.floor((Date.now() - Number(t)) / 1000);
        if(s < 30) return 'Just now';
        if(s < 3600) return Math.floor(s/60) + 'm ago';
        if(s < 86400) return Math.floor(s/3600) + 'h ago';
        return Math.floor(s/86400) + 'd ago';
    }

    // Firebase init (defensive)
    const firebaseConfig = {
        apiKey: "AIzaSyCTdVcJspQxXiq_Kd7ImL32xWsjv0HgENE",
        authDomain: "gossip-girl-4c9f2.firebaseapp.com",
        projectId: "gossip-girl-4c9f2",
        databaseURL: "https://gossip-girl-4c9f2-default-rtdb.firebaseio.com"
    };

    let db = null;
    try {
        if (typeof firebase !== 'undefined' && firebase && typeof firebase.initializeApp === 'function') {
            if (!firebase.apps || !firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } else {
            console.warn('Firebase SDK missing or unavailable.');
        }
    } catch (err) {
        console.error('Firebase init error', err);
        db = null;
    }

    const pid = new URLSearchParams(window.location.search).get('id');
    const myUid = localStorage.getItem('gg_id') || 'anon';
    const IS_GG = sessionStorage.getItem('admin_auth') === 'true';

    // Elements
    const postArea = document.getElementById('postArea');
    const cFeed = document.getElementById('cFeed');
    const commentCountEl = document.getElementById('commentCount');
    const ci = document.getElementById('ci');
    const cb = document.getElementById('cb');
    const replyBanner = document.getElementById('replyBanner');
    const replyCancel = document.getElementById('replyCancel');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const ggToast = document.getElementById('ggToast');

    if (!pid) {
        // No id: redirect to index (defensive)
        console.warn('Missing id param, redirecting to home.');
        setTimeout(() => { window.location.href = 'index.html'; }, 300);
        return;
    }

    // Reply state
    let replyToId = null;
    let isSubmitting = false;

    // Helper: set innerHTML with escaped text for user content
    function createTextNodeHTML(text) {
        return escapeHTML(text || '');
    }

    // Render main post safely
    function renderMainPost(p) {
        if (!postArea) return;
        // Defensive defaults
        p = p || {};
        const vCount = safeNumber(p.verifyCount || 0);
        const views = safeNumber(p.views || 0);
        const date = p.date || 0;
        // badges
        const badges = [];
        if (p.verifiedByGG) badges.push('<span class="badge b-gg">Verified by Gossip Girl</span>');
        if ((Date.now() - date) < 43200000) badges.push('<span class="badge b-new">New</span>');
        if (vCount >= 100) badges.push('<span class="badge b-new" style="background:#fff;color:#000;">Confirmed</span>');

        if (typeof p.text === 'string') {
            // safe: insert sanitized HTML only where necessary
        } else {
            p.text = '';
        }

        // Build DOM nodes rather than raw innerHTML to minimize XSS risk
        postArea.innerHTML = ''; // clear
        const outer = document.createElement('div');
        outer.className = 'liquid-card post-box';
        outer.style.padding = '24px';
        outer.style.borderRadius = '28px';
        outer.style.position = 'relative';

        // reads
        const reads = document.createElement('div');
        reads.style.position = 'absolute';
        reads.style.top = '24px';
        reads.style.right = '24px';
        reads.style.fontSize = '10px';
        reads.style.color = 'var(--gold-primary)';
        reads.style.fontWeight = '700';
        reads.style.opacity = '0.8';
        reads.textContent = 'ðŸ‘ ' + views + ' READS';
        outer.appendChild(reads);

        // badges container
        if (badges.length) {
            const bWrap = document.createElement('div');
            bWrap.style.marginBottom = '14px';
            bWrap.style.display = 'flex';
            bWrap.style.flexWrap = 'wrap';
            bWrap.style.maxWidth = '75%';
            bWrap.innerHTML = badges.join('');
            outer.appendChild(bWrap);
        }

        // header area
        const headerRow = document.createElement('div');
        headerRow.style.display = 'flex';
        headerRow.style.gap = '12px';
        headerRow.style.alignItems = 'center';
        headerRow.style.marginBottom = '20px';

        const avatar = document.createElement('div');
        avatar.style.width = '38px';
        avatar.style.height = '38px';
        avatar.style.background = 'rgba(255,255,255,0.05)';
        avatar.style.borderRadius = '50%';
        avatar.style.display = 'flex';
        avatar.style.alignItems = 'center';
        avatar.style.justifyContent = 'center';
        avatar.style.fontSize = '18px';
        avatar.style.border = '1px solid rgba(255,255,255,0.1)';
        avatar.style.color = 'var(--gold-primary)';
        avatar.style.fontFamily = "'Bodoni Moda'";
        avatar.style.fontStyle = 'italic';
        avatar.textContent = '?';
        headerRow.appendChild(avatar);

        const headerMeta = document.createElement('div');
        headerMeta.style.flex = '1';

        const nameRow = document.createElement('div');
        nameRow.style.display = 'flex';
        nameRow.style.alignItems = 'center';

        const anon = document.createElement('div');
        anon.style.fontWeight = '700';
        anon.style.fontSize = '14px';
        anon.style.color = '#fff';
        anon.textContent = 'Anonymous';
        nameRow.appendChild(anon);

        if (vCount > 0) {
            const vInd = document.createElement('div');
            vInd.className = 'v-indicator';
            vInd.textContent = String(vCount);
            vInd.style.marginLeft = '8px';
            nameRow.appendChild(vInd);
        }

        headerMeta.appendChild(nameRow);

        const timeEl = document.createElement('div');
        timeEl.style.fontSize = '10px';
        timeEl.style.opacity = '0.5';
        timeEl.style.fontWeight = '600';
        timeEl.textContent = timeAgo(date);
        headerMeta.appendChild(timeEl);

        headerRow.appendChild(headerMeta);
        outer.appendChild(headerRow);

        // text content
        const textDiv = document.createElement('div');
        textDiv.style.fontSize = '16px';
        textDiv.style.lineHeight = '1.5';
        textDiv.style.marginBottom = '20px';
        textDiv.style.color = 'rgba(255,255,255,0.92)';
        textDiv.style.fontWeight = '400';
        textDiv.style.letterSpacing = '0.1px';
        textDiv.innerHTML = createTextNodeHTML(p.text);
        outer.appendChild(textDiv);

        // image if exists (safe src, but still use fallback)
        if (p.image) {
            const img = document.createElement('img');
            img.className = 'post-img-preview';
            img.alt = 'post image';
            try { img.src = p.image; } catch(e){ img.src = ''; }
            img.loading = 'lazy';
            img.style.cursor = 'zoom-in';
            img.addEventListener('click', () => openLightbox(p.image));
            outer.appendChild(img);
        }

        // action row: verify & share (delegated events)
        const actionRow = document.createElement('div');
        actionRow.id = 'actionRow';
        actionRow.style.display = 'flex';
        actionRow.style.gap = '12px';
        actionRow.style.justifyContent = 'space-between';
        actionRow.style.alignItems = 'center';
        actionRow.style.borderTop = '1px solid rgba(255,255,255,0.08)';
        actionRow.style.paddingTop = '16px';

        const vBtn = document.createElement('button');
        vBtn.id = 'vBtn';
        vBtn.className = 'verify-btn';
        vBtn.textContent = (IS_GG || (p.verifiers && p.verifiers[myUid]) || p.verifiedByGG) ? 'VERIFIED' : 'VERIFY';
        if (IS_GG || p.verifiedByGG || (p.verifiers && p.verifiers[myUid])) vBtn.classList.add('active');
        actionRow.appendChild(vBtn);

        const sBtn = document.createElement('button');
        sBtn.id = 'sBtn';
        sBtn.className = 'share-btn';
        sBtn.textContent = 'SHARE';
        actionRow.appendChild(sBtn);

        outer.appendChild(actionRow);
        postArea.appendChild(outer);

        // attach behaviors
        vBtn.addEventListener('click', () => toggleVerify(pid, vBtn));
        sBtn.addEventListener('click', () => shareTip());
    }

    // Lightbox open/close (accessible)
    function openLightbox(url) {
        try {
            lightboxImg.src = url || '';
            lightbox.style.display = 'flex';
            lightbox.setAttribute('aria-hidden', 'false');
            // trap simple escape
            setTimeout(() => window.addEventListener('keydown', lightboxEsc), 0);
        } catch(e){console.warn(e);}
    }
    function closeLightbox() {
        lightbox.style.display = 'none';
        lightboxImg.src = '';
        lightbox.setAttribute('aria-hidden', 'true');
        window.removeEventListener('keydown', lightboxEsc);
    }
    function lightboxEsc(e){ if(e.key === 'Escape') closeLightbox(); }

    // Click outside to close
    lightbox.addEventListener('click', (ev) => {
        if (ev.target === lightbox) closeLightbox();
    });

    // Toggle verify: uses transaction when possible (defensive)
    function toggleVerify(pidLocal, btnEl) {
        if (!db) { alert('Connection error.'); return; }
        const ref = db.ref('posts/' + pidLocal);
        ref.transaction(p => {
            if (!p) return p;
            if (IS_GG) {
                p.verifiedByGG = true;
            } else {
                p.verifiers = p.verifiers || {};
                if (p.verifiers[myUid]) {
                    delete p.verifiers[myUid];
                    p.verifyCount = Math.max(0, safeNumber(p.verifyCount) - 1);
                    // btn text will update via callback
                } else {
                    p.verifiers[myUid] = true;
                    p.verifyCount = safeNumber(p.verifyCount) + 1;
                }
            }
            return p;
        }, (error, committed, snapshot) => {
            if (error) {
                console.error('Verify transaction failed', error);
                return;
            }
            if (committed && IS_GG) {
                // show toast
                if (ggToast) {
                    ggToast.style.display = 'block';
                    setTimeout(() => ggToast.style.display = 'none', 3000);
                }
            }
            // Update UI quickly (best-effort)
            try {
                const newP = snapshot && snapshot.val() ? snapshot.val() : null;
                if (newP && btnEl) {
                    const has = (IS_GG || newP.verifiedByGG || (newP.verifiers && newP.verifiers[myUid]));
                    btnEl.textContent = has ? 'VERIFIED' : 'VERIFY';
                    btnEl.classList.toggle('active', Boolean(has));
                }
            } catch(e){}
        });
    }

    // Render comments safely and set up swipe replies
    function renderComments(data) {
        if (!cFeed || !commentCountEl) return;
        data = data || {};
        const keys = Object.keys(data || {});
        if (keys.length === 0) {
            cFeed.innerHTML = '<div class="empty-state">What do you have in mind?</div>';
            commentCountEl.textContent = '0';
            return;
        }

        // separate main comments and replies
        const main = [];
        const replies = {};
        keys.forEach(k => {
            const c = data[k];
            if (!c) return;
            c.id = k;
            if (c.replyTo) {
                replies[c.replyTo] = replies[c.replyTo] || [];
                replies[c.replyTo].push(c);
            } else main.push(c);
        });

        commentCountEl.textContent = String(keys.length);

        // build HTML via DOM for safety
        cFeed.innerHTML = '';
        // sort by date desc
        main.sort((a,b) => (safeNumber(b.date) - safeNumber(a.date))).forEach((c, idx) => {
            const wrap = document.createElement('div');
            wrap.className = 'comment-swipe-zone';
            wrap.id = 'wrap-' + sanitizeForId(c.id);

            wrap.style.animation = 'liquidReveal 0.6s cubic-bezier(0.2,0.8,0.2,1) forwards';
            wrap.style.animationDelay = (idx * 0.05) + 's';
            wrap.style.opacity = '0';
            wrap.style.transform = 'translateY(20px)';

            const card = document.createElement('div');
            card.className = 'liquid-card main-card';
            card.style.padding = '18px';
            card.style.position = 'relative';
            card.style.zIndex = '2';
            card.style.transition = 'background 0.2s';

            const headerRow = document.createElement('div');
            headerRow.style.display = 'flex';
            headerRow.style.gap = '10px';
            headerRow.style.marginBottom = '8px';
            headerRow.style.alignItems = 'center';

            const avatar = document.createElement('div');
            avatar.style.width = '28px';
            avatar.style.height = '28px';
            avatar.style.background = 'linear-gradient(135deg, #222, #111)';
            avatar.style.borderRadius = '50%';
            avatar.style.display = 'flex';
            avatar.style.alignItems = 'center';
            avatar.style.justifyContent = 'center';
            avatar.style.fontSize = '12px';
            avatar.style.border = '1px solid rgba(255,255,255,0.1)';
            avatar.style.color = 'var(--gold-primary)';
            avatar.style.fontFamily = "'Bodoni Moda'";
            avatar.style.fontStyle = 'italic';
            avatar.textContent = '?';
            headerRow.appendChild(avatar);

            const meta = document.createElement('div');
            meta.style.flex = '1';
            const name = document.createElement('div');
            name.style.fontWeight = '700';
            name.style.fontSize = '12px';
            name.style.color = '#fff';
            name.textContent = 'Anonymous';
            meta.appendChild(name);
            const t = document.createElement('div');
            t.style.fontSize = '9px';
            t.style.opacity = '0.4';
            t.style.fontWeight = '600';
            t.textContent = timeAgo(c.date);
            meta.appendChild(t);
            headerRow.appendChild(meta);
            card.appendChild(headerRow);

            const txt = document.createElement('div');
            txt.style.fontSize = '13px';
            txt.style.lineHeight = '1.4';
            txt.style.color = 'rgba(255,255,255,0.9)';
            txt.innerHTML = createTextNodeHTML(c.text);
            card.appendChild(txt);

            wrap.appendChild(card);

            // replies
            if (replies[c.id]) {
                const repliesWrap = document.createElement('div');
                repliesWrap.style.marginLeft = '20px';
                repliesWrap.style.marginTop = '8px';
                repliesWrap.style.borderLeft = '1.5px solid rgba(255,255,255,0.08)';
                repliesWrap.style.paddingLeft = '12px';

                replies[c.id].forEach(r => {
                    const rCard = document.createElement('div');
                    rCard.className = 'liquid-card';
                    rCard.style.padding = '12px';
                    rCard.style.marginBottom = '8px';
                    rCard.style.borderRadius = '18px';
                    rCard.style.background = 'rgba(255,255,255,0.02)';
                    rCard.style.border = '1px solid rgba(255,255,255,0.04)';
                    const rTag = document.createElement('div');
                    rTag.style.fontWeight = '700';
                    rTag.style.fontSize = '9px';
                    rTag.style.color = 'var(--gold-primary)';
                    rTag.style.marginBottom = '4px';
                    rTag.style.opacity = '0.8';
                    rTag.textContent = 'REPLY';
                    rCard.appendChild(rTag);
                    const rText = document.createElement('div');
                    rText.style.fontSize = '12px';
                    rText.style.opacity = '0.9';
                    rText.style.lineHeight = '1.4';
                    rText.innerHTML = createTextNodeHTML(r.text);
                    rCard.appendChild(rText);
                    repliesWrap.appendChild(rCard);
                });

                wrap.appendChild(repliesWrap);
            }

            cFeed.appendChild(wrap);

            // attach swipe handler
            setupSwipeHandler(c.id, wrap, card);
        });
    }

    // swipe to reply handler
    function setupSwipeHandler(cid, row, card) {
        if(!row || !card) return;
        let startX = 0, startY = 0, isSwiping = false, isScrolling = false;

        row.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            isSwiping = false;
            isScrolling = false;
            card.style.transition = 'none';
        }, {passive:true});

        row.addEventListener('touchmove', (e) => {
            const diffX = startX - e.touches[0].clientX;
            const diffY = Math.abs(startY - e.touches[0].clientY);

            if (!isSwiping && !isScrolling) {
                if (diffY > 10) isScrolling = true;
                else if (diffX > 10) isSwiping = true;
            }

            if (isSwiping && diffX > 0) {
                const move = Math.min(diffX, 80);
                requestAnimationFrame(()=> { card.style.transform = `translateX(-${move}px)`; });
                if (diffX > 70 && replyToId !== cid) {
                    replyToId = cid;
                    if (replyBanner) replyBanner.style.display = 'flex';
                    try { if (navigator.vibrate) navigator.vibrate(10); } catch(e){}
                    card.style.background = 'rgba(255,255,255,0.08)';
                }
            }
        }, {passive:true});

        row.addEventListener('touchend', () => {
            card.style.transition = 'transform 0.4s cubic-bezier(0.175,0.885,0.32,1.15), background 0.3s';
            card.style.transform = 'translateX(0px)';
            setTimeout(()=>{ if(!replyToId || replyToId !== cid) card.style.background = ''; }, 400);
        }, {passive:true});
    }

    // Share: capture post area & try Web Share; fallback to downloading image
    function shareTip() {
        const cap = document.getElementById('captureArea') || document.querySelector('.post-box') || postArea;
        if (!cap) { alert('Nothing to share'); return; }
        if (typeof html2canvas === 'undefined') {
            alert('Sharing is unavailable (html2canvas missing).');
            return;
        }

        // hide action row if present to make cleaner capture
        const actionRow = document.getElementById('actionRow');
        if (actionRow) actionRow.style.display = 'none';

        // capture
        try {
            html2canvas(cap, { backgroundColor: '#050505', scale: 2, useCORS: true, logging: false, scrollY: -window.scrollY })
            .then(canvas => {
                if (actionRow) actionRow.style.display = 'flex';
                canvas.toBlob(blob => {
                    if (!blob) { alert('Share failed'); return; }
                    const file = new File([blob], 'gossip_girl_spotted.png', { type: 'image/png' });
                    const shareText = `Have you checked Gossip Girl? (${window.location.href})`;

                    // prefer native share with files when available
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        navigator.share({ files: [file], title: 'Gossip Girl', text: shareText })
                        .catch(err => console.log('Share failed', err));
                    } else if (navigator.share) {
                        // fallback to text share
                        navigator.share({ title: 'Gossip Girl', text: shareText })
                        .catch(err => console.log('Fallback share failed', err));
                    } else {
                        // final fallback: offer download link
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'gossip_girl_spotted.png';
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(url);
                    }
                }, 'image/png', 0.9);
            })
            .catch(err => {
                if (actionRow) actionRow.style.display = 'flex';
                console.error('html2canvas capture failed', err);
                alert('Capture failed.');
            });
        } catch (err) {
            if (actionRow) actionRow.style.display = 'flex';
            console.error(err);
            alert('Share failed.');
        }
    }

    // submit comment
    cb.addEventListener('click', () => {
        if (isSubmitting) return;
        const txt = (ci && ci.value) ? ci.value.trim() : '';
        if (!txt) return;
        if (!db) {
            // local fallback
            try {
                const local = JSON.parse(localStorage.getItem('local_comments') || '[]');
                local.push({ text: txt, date: Date.now(), replyTo: replyToId || null, local: true });
                localStorage.setItem('local_comments', JSON.stringify(local));
                ci.value = '';
                cancelReply();
                // re-render local appended comment for instant feedback
                // (not wired into cFeed here, but user won't lose input)
            } catch(e){}
            return;
        }
        isSubmitting = true;
        const payload = { text: txt, date: firebase.database.ServerValue.TIMESTAMP, replyTo: replyToId || null };
        db.ref('comments/' + pid).push(payload)
        .then(()=> {
            ci.value = '';
            cancelReply();
        })
        .catch(err => {
            console.error('Comment push failed', err);
            alert('Failed to send comment.');
        })
        .finally(()=> { isSubmitting = false; });
    });

    // Enter key to submit (accessible)
    ci.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            cb.click();
        }
    });

    // reply cancel
    function cancelReply() {
        replyToId = null;
        if (replyBanner) replyBanner.style.display = 'none';
        // reset card backgrounds
        document.querySelectorAll('.main-card').forEach(c => { c.style.background = ''; });
    }
    if (replyCancel) {
        replyCancel.addEventListener('click', cancelReply);
        replyCancel.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') cancelReply(); });
    }

    // Wire up close on escape for popups (global)
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (lightbox && lightbox.style.display === 'flex') closeLightbox();
            if (replyBanner && replyBanner.style.display === 'flex') cancelReply();
        }
    });

    // DB listeners (defensive)
    function initListeners() {
        if (!db) {
            // degrade gracefully: show message if needed
            console.warn('No database connection. Showing offline state.');
            // Still render offline placeholders
            renderMainPost({ text: 'Offline: unable to load post.', date: Date.now(), image: null, views: 0, verifyCount: 0 });
            renderComments({});
            return;
        }

        // increment view count once per client per post
        try {
            let viewed = JSON.parse(localStorage.getItem('gg_viewed_posts') || '[]');
            if (!Array.isArray(viewed)) viewed = [];
            if (!viewed.includes(pid)) {
                // safe transaction for views
                const viewsRef = db.ref('posts/' + pid + '/views');
                viewsRef.transaction(v => (safeNumber(v) + 1));
                viewed.push(pid);
                localStorage.setItem('gg_viewed_posts', JSON.stringify(viewed));
            }
        } catch(e){ console.warn('views increment error', e); }

        // listen to comments
        db.ref('comments/' + pid).on('value', snap => {
            const data = snap.val() || {};
            renderComments(data);
        }, err => {
            console.warn('comments listener error', err);
            renderComments({});
        });

        // listen to post
        db.ref('posts/' + pid).on('value', snap => {
            const p = snap.val();
            if (!p) {
                // post missing -> redirect or show message
                setTimeout(()=>{ window.location.href = 'index.html'; }, 300);
                return;
            }
            renderMainPost(p);
        }, err => {
            console.warn('post listener error', err);
        });
    }

    // initial
    initListeners();

    // Expose minimal helpers for debugging (no globals for user content)
    window.openLightbox = openLightbox;
    window.closeLightbox = closeLightbox;

})();
</script>
</body>
</html>